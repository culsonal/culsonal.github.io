const len2=([t,e])=>Math.sqrt(t*t+e*e),add2=([t,e],[a,r])=>[t+a,e+r],sub2=([t,e],[a,r])=>[t-a,e-r],madd2=(t,e)=>[t[0]+e[0],t[1]+e[1],t[2]+e[2],t[3]+e[3]],clamp=(t,e,a)=>Math.max(Math.min(t,a),e),outer_prod_vwT=(t,e)=>[t[0]*e[0],t[0]*e[1],t[1]*e[0],t[1]*e[1]],transpose=t=>[t[0],t[2],t[1],t[3]],mat_vec_prod=(t,e)=>[t[0]*e[0]+t[1]*e[1],t[2]*e[0]+t[3]*e[1]],mat_mat_prod=(t,e)=>[t[0]*e[0]+t[1]*e[2],t[0]*e[1]+t[1]*e[3],t[2]*e[0]+t[3]*e[2],t[2]*e[1]+t[3]*e[3]],mat_mat_sum=(t,e)=>[t[0]+e[0],t[1]+e[1],t[2]+e[2],t[3]+e[3]],scale4=(t,e)=>[t[0]*e,t[1]*e,t[2]*e,t[3]*e],inv_matr_2x2=([t,e,a,r])=>{const o=1/(t*r-e*a);return[r*o,-e*o,-a*o,t*o]},dist2=([t,e],[a,r])=>Math.hypot(t-a,e-r),det2=([t,e,a,r])=>t*r-e*a,mat_mat_prod2x2=([t,e,a,r],[o,n,s,_])=>[t*o+e*s,t*n+e*_,a*o+r*s,a*n+r*_],compute_neohookean_2d_deltas=(t,e,[a,r])=>{const[[o,n],[s,_],[l,d]]=t,[[h,u],[m,c],[i,b]]=e,f=[s-o,l-o,_-n,d-n],p=[m-h,i-h,c-u,b-u],y=1/det2(p),[g,v,M,k]=[y*p[3],-y*p[1],-y*p[2],y*p[0]],[x,q,w,T]=mat_mat_prod2x2(f,[g,v,M,k]),[j,z]=[y*(_-d),y*(l-s)],[A,B]=[y*(d-n),y*(o-l)],[C,D]=[y*(n-_),y*(s-o)],E=j**2+z**2+A**2+B**2+C**2+D**2;if(E<1e-6)return[[0,0],[0,0],[0,0]];const F=-(det2([x,q,w,T])-(1+r/a))*a/E,[G,H]=[F*j,F*z],[I,J]=[F*A,F*B],[K,L]=[F*C,F*D],N=Math.sqrt(x**2+q**2+w**2+T**2),O=-(x*g+x*M+q*v+q*k)/N,P=-(w*g+w*M+T*v+T*k)/N,[Q,R]=[(x*g+q*v)/N,(w*g+T*v)/N],[S,U]=[(x*M+q*k)/N,(w*M+T*k)/N],V=O**2+P**2+Q**2+R**2+S**2+U**2;if(V<1e-6)return[[0,0],[0,0],[0,0]];const W=-N*r/V,[X,Y]=[W*O,W*P],[Z,$]=[W*Q,W*R],[tt,et]=[W*S,W*U];return[[G+X,H+Y],[I+Z,J+$],[K+tt,L+et]]},solve_neohookean_constraints=(t,e,a,r,[o,n]=[.3,.03])=>{for(let s=0;s<t.length;s++)if(r[s]){const[r,_,l]=t[s],[d,h]=[e.subarray(2*r,2*r+2),a.subarray(2*r,2*r+2)],[u,m]=[e.subarray(2*_,2*_+2),a.subarray(2*_,2*_+2)],[c,i]=[e.subarray(2*l,2*l+2),a.subarray(2*l,2*l+2)],[[b,f],[p,y],[g,v]]=compute_neohookean_2d_deltas([d,u,c],[h,m,i],[o,n]);e[2*r]+=b,e[2*r+1]+=f,e[2*_]+=p,e[2*_+1]+=y,e[2*l]+=g,e[2*l+1]+=v}},neohookean_2d_energies=(t,e)=>{const[[a,r],[o,n],[s,_]]=t,[[l,d],[h,u],[m,c]]=e,i=[o-a,s-a,n-r,_-r],b=[h-l,m-l,u-d,c-d],f=1/det2(b),[p,y,g,v]=[f*b[3],-f*b[1],-f*b[2],f*b[0]],[M,k,x,q]=mat_mat_prod2x2(i,[p,y,g,v]);return[det2([M,k,x,q]),Math.sqrt(M**2+k**2+x**2+q**2)]},deactivate_if_above_tear_limit=(t,e,a,r,[o,n])=>{for(let s=0;s<t.length;s++){const[_,l,d]=t[s],[h,u]=[e.subarray(2*_,2*_+2),a.subarray(2*_,2*_+2)],[m,c]=[e.subarray(2*l,2*l+2),a.subarray(2*l,2*l+2)],[i,b]=[e.subarray(2*d,2*d+2),a.subarray(2*d,2*d+2)],[f,p]=neohookean_2d_energies([h,m,i],[u,c,b]);(f>o||p>n)&&(r[s]=!1)}};export const pbd_update=(t,e,a,r,o,n,s,[_,l],[d,h],[u,m,c,i])=>{const b=.2/3;for(let _=0;_<3;_++){a.set(t);for(let e=0;e<t.length;e++)t[e]+=b*r[e];solve_neohookean_constraints(o,t,e,s,[d,h]);for(let a=0;a<n.length;a++)t.set(e.subarray(2*n[a],2*n[a]+2),2*n[a]);for(let e=0;e<t.length/2;e++)t[2*e]=clamp(t[2*e],-1,1);for(let e=0;e<t.length/2;e++)t[2*e+1]=clamp(t[2*e+1],-1,1);for(let e=0;e<t.length;e++)r[e]=(t[e]-a[e])/b;for(let e=0;e<t.length/2;e++)r[2*e+1]+=8e-4;for(let e=0;e<t.length;e++)r[e]*=.998}deactivate_if_above_tear_limit(o,t,e,s,[_,l]);const[f,p]=[.1,5];for(let e=0;e<t.length/2;e++)Math.sqrt((t[2*e]-u)**2+(t[2*e+1]-m)**2)<f&&r.set([c*p,i*p],2*e)};

